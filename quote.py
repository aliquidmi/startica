import random, logging
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import CommandHandler, ContextTypes, MessageHandler, filters
from keyboards import get_main_keyboard

logger = logging.getLogger(__name__)

REPEAT_QUOTE_TEXT = "–©–µ —Ü–∏—Ç–∞—Ç–∞"

QUOTES = [
    '"–£—Å–ø—ñ—Ö ‚Äî —Ü–µ –Ω–µ –∫—ñ–Ω–µ—Ü—å, –ø–æ—Ä–∞–∑–∫–∞ ‚Äî –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞: –≤–∞–∂–ª–∏–≤–∞ –ª–∏—à–µ –º—É–∂–Ω—ñ—Å—Ç—å –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏." ‚Äî –í—ñ–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å',
    '"–ü—Ä–∞—Ü—é–π –º–æ–≤—á–∫–∏. –ù–µ—Ö–∞–π —É—Å–ø—ñ—Ö –≥–æ–≤–æ—Ä–∏—Ç—å –∑–∞ —Ç–µ–±–µ." ‚Äî –§—Ä–∞–Ω–∫ –û—É—à–µ–Ω',
    '"–ù–µ —á–µ–∫–∞–π —ñ–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç—É ‚Äî —Å—Ç–≤–æ—Ä–∏ –π–æ–≥–æ —Å–∞–º." ‚Äî –î–∂–æ—Ä–¥–∂ –ë–µ—Ä–Ω–∞—Ä–¥ –®–æ—É (–ø—Ä–∏–±–ª–∏–∑–Ω–∞ —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è)',
    '"–í–µ–ª–∏–∫—ñ –º—Ä—ñ—ó —Ä–æ–±–ª—è—Ç—å –≤–µ–ª–∏–∫—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è." ‚Äî –ù–æ—Ä–º–∞–Ω –í—ñ–Ω—Å–µ–Ω—Ç –ü—ñ–ª',
    '"–•—Ç–æ —Ö–æ—á–µ ‚Äî —à—É–∫–∞—î –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, —Ö—Ç–æ –Ω–µ —Ö–æ—á–µ ‚Äî —à—É–∫–∞—î –ø—Ä–∏—á–∏–Ω–∏." ‚Äî –Ω–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä',
    '"–¢—ñ–ª—å–∫–∏ —Ç–æ–π, —Ö—Ç–æ –π–¥–µ, –∑–¥–æ–ª–∞—î –¥–æ—Ä–æ–≥—É." ‚Äî –Ω–∞—Ä–æ–¥–Ω–∞ –º—É–¥—Ä—ñ—Å—Ç—å',
    '"–©–æ–± –¥—ñ–π—Ç–∏ –¥–æ –º–µ—Ç–∏, –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞—Å–∞–º–ø–µ—Ä–µ–¥ —ñ—Ç–∏." ‚Äî –û–Ω–æ—Ä–µ –¥–µ –ë–∞–ª—å–∑–∞–∫',
    '"–ó–º—ñ–Ω–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ —Ç–µ–±–µ." ‚Äî –ú–∞–π–∫–ª –î–∂–µ–∫—Å–æ–Ω (–≤—ñ–¥–æ–º–æ –∑ –ø—ñ—Å–Ω—ñ ¬´Man in the Mirror¬ª)',
    '"–ù–µ –±—ñ–π—Å—è –ø–æ–º–∏–ª–æ–∫ ‚Äî –±—ñ–π—Å—è –±–µ–∑–¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ." ‚Äî –î–∂–æ–Ω –í—É–¥–µ–Ω',
    '"–ö–æ–∂–µ–Ω –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∏–π —à–∞–Ω—Å –∑–º—ñ–Ω–∏—Ç–∏ –∂–∏—Ç—Ç—è." ‚Äî –Ω–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä',
    '"–¢–∏ —Å–∏–ª—å–Ω—ñ—à–∏–π, –Ω—ñ–∂ –¥—É–º–∞—î—à." ‚Äî –ö—Ä—ñ—Å—Ç–æ—Ñ–µ—Ä –†–æ–±—ñ–Ω (–∑ —Ç–≤–æ—Ä—ñ–≤ –ê. –ê. –ú—ñ–ª–Ω–∞)',
    '"–ü–∞–¥–∞–≤ ‚Äî –≤—Å—Ç–∞–≤–∞–π. –í–ø–∞–≤ –∑–Ω–æ–≤—É ‚Äî –≤—Å—Ç–∞–≤–∞–π —à–≤–∏–¥—à–µ." ‚Äî –í–∏–Ω –î–∏–∑–µ–ª—å (–≤—ñ–¥–æ–º–µ –∑ —ñ–Ω—Ç–µ—Ä–≤`—é)',
    '"–©–∞—Å—Ç—è ‚Äî —Ü–µ —à–ª—è—Ö, –∞ –Ω–µ –ø—É–Ω–∫—Ç –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è." ‚Äî –†–æ–π –ú. –ì—É–¥–º–∞–Ω',
    '"–õ—é–¥–∏–Ω–∞ —Å—Ç–∞—î —Ç–∏–º, —É —â–æ –≤–æ–Ω–∞ –≤—ñ—Ä–∏—Ç—å." ‚Äî –ú–∞—Ö–∞—Ç–º–∞ –ì–∞–Ω–¥—ñ',
    '"–ù–µ–º–∞—î –Ω—ñ—á–æ–≥–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ–≥–æ –¥–ª—è —Ç–æ–≥–æ, —Ö—Ç–æ –ø—Ä–∞–≥–Ω–µ." ‚Äî –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å—å–∫–∏–π',
    '"–î—ñ–π, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –±–æ—ó—à—Å—è." ‚Äî –®–µ—Ä—ñ–ª –°–µ–Ω–¥–±–µ—Ä–≥',
    '"–ù—ñ–∫–æ–ª–∏ –Ω–µ –ø—ñ–∑–Ω–æ –ø–æ—á–∞—Ç–∏ –∑ –ø–æ—á–∞—Ç–∫—É." ‚Äî –î–∂–æ–µ–ª –û—Å—Ç—ñ–Ω',
    '"–£—Å–ø—ñ—Ö –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –¥–æ —Ç–∏—Ö, —Ö—Ç–æ –¥—ñ—î." ‚Äî –ù–∞–ø–æ–ª–µ–æ–Ω –ì—ñ–ª–ª',
    '"–ú—Ä—ñ–π –º–∞—Å—à—Ç–∞–±–Ω–æ, –¥—ñ–π –≤–ø–µ–≤–Ω–µ–Ω–æ." ‚Äî –¢–æ–Ω—ñ –†–æ–±–±—ñ–Ω—Å',
    '"–ö–æ–∂–Ω–∞ —Å–ø—Ä–æ–±–∞ ‚Äî —Ü–µ –∫—Ä–æ–∫ –¥–æ –º–µ—Ç–∏." ‚Äî –¢–æ–º–∞—Å –ï–¥—ñ—Å–æ–Ω'
]

def get_quote_keyboard():
    return ReplyKeyboardMarkup(
        [[KeyboardButton("–ù–∞–∑–∞–¥"), KeyboardButton(REPEAT_QUOTE_TEXT)]],
        resize_keyboard=True
    )

async def quote_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        text = update.message.text
        logger.info(f"–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: '{text}'")

        if text in ["/quote", "üòÑ –¶–∏—Ç–∞—Ç–∞", REPEAT_QUOTE_TEXT]:
            if not QUOTES:
                await update.message.reply_text("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π.")
                logger.warning("–ó–∞–ø–∏—Ç /quote, –∞–ª–µ —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π.")
                return

            quote = random.choice(QUOTES)
            await update.message.reply_text(f'üí° {quote}', reply_markup=get_quote_keyboard())
            logger.info("–ù–∞–¥—ñ—Å–ª–∞–Ω–æ –≤–∏–ø–∞–¥–∫–æ–≤—É —Ü–∏—Ç–∞—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É.")

        elif text == "–ù–∞–∑–∞–¥":
            await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=get_main_keyboard())
            logger.info("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è —É –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é.")

        else:
            logger.debug(f"–ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π –≤–≤—ñ–¥ —É quote_handler: '{text}' ‚Äî —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è.")

    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ quote_handler: {e}")
        await update.message.reply_text("‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ —Ü–∏—Ç–∞—Ç–∏.")

def get_handler():
    return [
        CommandHandler("quote", quote_handler),
        MessageHandler(
            filters.TEXT & filters.Regex(rf"^(üòÑ –¶–∏—Ç–∞—Ç–∞|{REPEAT_QUOTE_TEXT}|–ù–∞–∑–∞–¥|/quote)$"),
            quote_handler
        )
    ]
